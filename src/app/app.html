<div class="business-search-app">
  <!-- Two Column Layout -->
  <div class="main-layout">
    <!-- Header Row -->
    <div class="header-row">
      <!-- Top Left: Search Bar -->
      <div class="header-left">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Enter zip code or city</mat-label>
          <input 
            matInput 
            [formControl]="searchControl"
            [matAutocomplete]="auto"
            (keyup.enter)="performSearch()"
            placeholder="02138 or Cambridge">
          <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onOptionSelected($event.option.value)">
            @for (option of filteredOptions(); track option) {
              <mat-option [value]="option">
                {{ option }}
              </mat-option>
            }
          </mat-autocomplete>
        </mat-form-field>
        <button mat-raised-button color="accent" (click)="performSearch()" [disabled]="loading()">
          Search
        </button>
      </div>
      
      <!-- Top Right: Instructions/API Info -->
      <div class="header-right">
        @if (!apiCallInfo()) {
          <div class="instructions">
            <h3>2025 Hackathon Business Search</h3>
            <p>Enter a zip code (like 02138) or city name (like Cambridge) in the search field to find businesses in that area.</p>
          </div>
        }
        @if (apiCallInfo()) {
          <div class="api-info">
            <div class="api-row">
              <span class="api-label">Current API Call:</span>
              <code class="api-url">{{ apiCallInfo() }}</code>
              <a [href]="getApiUrl()" target="_blank" class="try-api-link">Try API</a>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Content Row -->
    @if (categories().length > 0) {
      <div class="content-row">
        <!-- Bottom Left: Categories -->
        <div class="content-left">
          <div class="categories-section">
            <!-- Categories button to show all businesses (replaces header) -->
            <div class="all-categories-button">
              <button 
                mat-button 
                class="category-button categories-root"
                [class.active]="selectedCategoryPath().length === 0"
                (click)="selectAllCategories()">
                Categories ({{ businesses().length }})
              </button>
            </div>
            <div class="category-tree">
              <ng-container *ngTemplateOutlet="categoryTemplate; context: { categories: categories(), level: 0 }"></ng-container>
            </div>
          </div>
        </div>
        
        <!-- Bottom Right: Business Results -->
        <div class="content-right">
          @if (filteredBusinesses().length > 0) {
            <div class="business-grid">
              @for (business of filteredBusinesses(); track business.yelpUrl) {
                <mat-card class="business-card">
                  <mat-card-header>
                    <mat-card-title>{{ business.name }}</mat-card-title>
                    <mat-card-subtitle>{{formatCategories(business.categories).join(", ") }}</mat-card-subtitle>
                  </mat-card-header>
                  <mat-card-content>
                    @if (business.address) {
                      <p><strong>Address:</strong> {{ business.address }}</p>
                    }
                    @if (business.rating) {
                      <p><strong>Rating:</strong> {{ business.rating }}/5 ({{ business.reviewCount }} reviews)</p>
                    }
                    @if (business.description) {
                      <p class="description"><strong>Description:</strong> {{ getFirstTwentyWords(business.description) }}</p>
                    }
                  </mat-card-content>
                  <mat-card-actions>
                    <a mat-button [href]="business.yelpUrl" target="_blank">View Yelp</a>
                    <button mat-raised-button color="accent" (click)="openHtmlViewer(business)">Get HTML</button>
                    @if (business.webDomain) {
                      <a mat-button [href]="'https://' + business.webDomain" target="_blank">Visit Domain</a>
                    }
                  </mat-card-actions>
                </mat-card>
              }
            </div>
          }
          @if (filteredBusinesses().length === 0 && !loading()) {
            <div class="no-businesses">
              <mat-card>
                <mat-card-content>
                  <p>No businesses found. Try selecting a different category or search for another location.</p>
                </mat-card-content>
              </mat-card>
            </div>
          }
        </div>
      </div>
    }
  </div>


  <!-- Loading indicator -->
  @if (loading()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Loading...</p>
    </div>
  }
</div>

<ng-template #categoryTemplate let-categories="categories" let-level="level">
  @for (category of categories; track category.name) {
    <div class="category-item" [style.margin-left.px]="level * 20">
      <div class="category-row">
        @if (category.children && category.children.length > 0) {
          <button 
            mat-icon-button 
            class="expand-button"
            (click)="toggleCategory(category)">
            <mat-icon>{{ isCategoryExpanded(category) ? 'expand_less' : 'expand_more' }}</mat-icon>
          </button>
        }
        
        <button 
          mat-button 
          class="category-button"
          [class.active]="isCategorySelected(category)"
          (click)="selectCategory(category)">
          {{ category.name }} ({{ category.businessUrls.length }})
        </button>
      </div>
      
      @if (isCategoryExpanded(category) && category.children && category.children.length > 0) {
        <div class="subcategories">
          <ng-container *ngTemplateOutlet="categoryTemplate; context: { categories: category.children, level: level + 1 }"></ng-container>
        </div>
      }
    </div>
  }
</ng-template>

<router-outlet />
